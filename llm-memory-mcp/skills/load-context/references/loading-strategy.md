# 上下文加载策略

## 加载级别

| 级别 | 场景 | 操作 | 耗时 |
|------|------|------|------|
| 快速 | 新对话开始 | 只列表，不获取详情 | 快 |
| 深度 | Plan 模式 | 列表 + 详情 + 搜索 | 较慢 |

## 快速加载流程

```
新对话开始
    ↓
plan_list() → 获取计划列表
    ↓
todo_list() → 获取任务列表
    ↓
简要展示概况
    ↓
完成
```

**适用场景**：
- 日常新对话
- 快速了解状态
- 不需要详细信息

## 深度加载流程

```
进入 Plan 模式
    ↓
plan_list() → 获取计划列表
    ↓
todo_list() → 获取任务列表
    ↓
memory_search() → 搜索相关记忆
    ↓
plan_get() → 获取关键计划详情
    ↓
memory_get() → 获取关键记忆详情
    ↓
详细展示上下文
    ↓
完成
```

**适用场景**：
- 进入 Plan 模式
- 需要详细规划
- 做重大决策前

## 加载顺序优化

### 优先加载

1. 进行中的计划（最重要）
2. 待处理的高优先级任务
3. 最近更新的记忆

### 按需加载

1. 已完成的计划（可选）
2. 低优先级任务
3. 旧的记忆

## 数据过滤

### 计划过滤

```javascript
// 按状态过滤
plans.filter(p => p.status === "in_progress")

// 按更新时间过滤（最近 7 天）
plans.filter(p => new Date(p.updated_at) > sevenDaysAgo)
```

### 任务过滤

```javascript
// 只看待处理和进行中
todos.filter(t => t.status === 0 || t.status === 1)

// 按优先级过滤
todos.filter(t => t.priority >= 3)
```

### 记忆过滤

```javascript
// 按关键词搜索
memory_search({ keyword: "auth" })

// 限制数量
memories.slice(0, 5)
```

## 输出格式

### 概览格式

```
📊 项目状态概览

📋 计划: X 进行中, Y 待开始
📝 任务: X 待处理, Y 进行中
💡 记忆: X 条相关
```

### 详细格式

```
═══════════════════════════════════════
📋 [plan-code] 计划标题 (进度%)
├── 目标: ...
├── 步骤: ...
└── Agent: ...
═══════════════════════════════════════
```

## 性能考虑

1. **限制详情获取数量**：最多获取 3-5 个详情
2. **并行请求**：列表请求可以并行
3. **缓存考虑**：同一对话中避免重复加载
